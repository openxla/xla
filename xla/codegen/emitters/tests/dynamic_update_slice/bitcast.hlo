// RUN: gpu_test_correctness %s
// RUN: cpu_test_correctness %s

fusion {
  in = f32[20,30] parameter(0)
  updates = f32[5,6] parameter(1)
  i0 = s32[] parameter(2)
  i1 = s32[] parameter(3)
  updated = f32[20,30] dynamic-update-slice(in, updates, i0, i1)
  ROOT bitcast = f32[600] bitcast(updated)
}

ENTRY main {
  %param_0 = f32[20,30] parameter(0)
  %param_1 = f32[5,6] parameter(1)
  %param_2 = s32[] parameter(2)
  %param_3 = s32[] parameter(3)
  // On CPU the input/output alias, this is resulting in a double free so we
  // need to copy the input.
  %param_0_copy = f32[20,30] copy(%param_0)
  ROOT %fusion = f32[600] fusion(%param_0_copy, %param_1, %param_2, %param_3), kind=kLoop, calls=fusion
}
